@model IEnumerable<dacn.Models.DanhMuc>

@{
    string loai = ViewBag.Loai ?? "Thu";
    string title = loai == "Thu" ? "Khoản Thu" : "Khoản Chi";
    ViewBag.Title = "Lọc " + title;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<main id="main" class="main">
    <div class="pagetitle">
        <h1>Lọc Giao Dịch @title</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="@Url.Action("Index", "TrangChu")">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="@Url.Action("Khoan" + loai, "DanhMucs")">@title</a></li>
                <li class="breadcrumb-item active">Lọc giao dịch</li>
            </ol>
        </nav>
    </div>

    <section class="section">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Bộ Lọc Giao Dịch</h5>

                        <!-- Form lọc -->
                        <form action="@Url.Action("Loc", "DanhMucs")" method="get" class="row g-3" id="filterForm">
                            <input type="hidden" name="loai" value="@loai" />

                            <div class="col-md-4">
                                <label class="form-label fw-bold">Loại lọc</label>
                                <select class="form-select" id="filterType" name="filterType">
                                    <option value="all">Tất cả giao dịch</option>
                                    <option value="date">Theo ngày cụ thể</option>
                                    <option value="month">Theo tháng</option>
                                    <option value="range">Theo khoảng thời gian</option>
                                    <option value="category">Theo danh mục</option>
                                </select>
                            </div>

                            <!-- Lọc theo ngày -->
                            <div class="col-md-4 filter-option" id="dateFilter" style="display: none;">
                                <label class="form-label">Ngày cụ thể</label>
                                <input type="date" class="form-control" id="specificDate" name="specificDate" value="@DateTime.Now.ToString("yyyy-MM-dd")">
                            </div>

                            <!-- Lọc theo tháng -->
                            <div class="col-md-4 filter-option" id="monthFilter" style="display: none;">
                                <label class="form-label">Tháng</label>
                                <input type="month" class="form-control" id="month" name="month" value="@DateTime.Now.ToString("yyyy-MM")">
                            </div>

                            <!-- Lọc theo khoảng thời gian -->
                            <div class="col-md-8 filter-option" id="rangeFilter" style="display: none;">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label class="form-label">Từ ngày</label>
                                        <input type="date" class="form-control" id="fromDate" name="fromDate" value="@DateTime.Now.AddDays(-30).ToString("yyyy-MM-dd")">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Đến ngày</label>
                                        <input type="date" class="form-control" id="toDate" name="toDate" value="@DateTime.Now.ToString("yyyy-MM-dd")">
                                    </div>
                                </div>
                            </div>

                            <!-- Lọc theo danh mục -->
                            <div class="col-md-4 filter-option" id="categoryFilter" style="display: none;">
                                <label class="form-label">Danh mục</label>
                                <select class="form-select" id="categoryId" name="categoryId">
                                    <option value="">Tất cả danh mục</option>
                                    @foreach (var category in Model.Where(d => d.Loai == loai))
                                    {
                                        <option value="@category.MaDanhMuc">@category.TenDanhMuc</option>
                                    }
                                </select>
                            </div>

                            <!-- Số tiền -->
                            <div class="col-md-4">
                                <label class="form-label">Số tiền từ</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="minAmount" name="minAmount" placeholder="0" step="0.01" min="0">
                                    <span class="input-group-text">VNĐ</span>
                                </div>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Đến</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="maxAmount" name="maxAmount" placeholder="Không giới hạn" step="0.01" min="0">
                                    <span class="input-group-text">VNĐ</span>
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-funnel me-2"></i>Áp dụng bộ lọc
                                        </button>
                                        <a href="@Url.Action("Khoan" + loai, "DanhMucs")" class="btn btn-secondary ms-2">
                                            <i class="bi bi-arrow-left me-2"></i>Quay lại
                                        </a>
                                    </div>
                                    <button type="button" class="btn btn-outline-danger" id="resetFilter">
                                        <i class="bi bi-arrow-clockwise me-2"></i>Đặt lại
                                    </button>
                                </div>
                            </div>
                        </form>

                        <hr class="my-4">

                        <!-- Kết quả lọc -->
                        <div id="filterResults">
                            <h6 class="text-muted mb-3">Kết quả giao dịch</h6>
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="resultsTable">
                                    <thead>
                                        <tr>
                                            <th>Ngày</th>
                                            <th>Mô tả</th>
                                            <th>Danh mục</th>
                                            <th>Số tiền</th>
                                            <th class="text-center">Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr id="noResults">
                                            <td colspan="5" class="text-center text-muted py-4">
                                                <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                                Chọn bộ lọc và nhấn "Áp dụng bộ lọc" để xem kết quả
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div class="text-muted" id="resultStats"></div>
                                <div id="pagination"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Hiển thị/ẩn các tùy chọn lọc
            $('#filterType').change(function () {
                $('.filter-option').hide();
                var selectedType = $(this).val();

                switch (selectedType) {
                    case 'date':
                        $('#dateFilter').show();
                        break;
                    case 'month':
                        $('#monthFilter').show();
                        break;
                    case 'range':
                        $('#rangeFilter').show();
                        break;
                    case 'category':
                        $('#categoryFilter').show();
                        break;
                }
            });

            // Kích hoạt lọc mặc định
            $('#filterType').trigger('change');

            // Reset bộ lọc
            $('#resetFilter').click(function () {
                $('#filterForm')[0].reset();
                $('#filterType').trigger('change');
                $('#resultsTable tbody').html(
                    '<tr id="noResults"><td colspan="5" class="text-center text-muted py-4">' +
                    '<i class="bi bi-inbox fs-1 d-block mb-2"></i>Chọn bộ lọc và nhấn "Áp dụng bộ lọc" để xem kết quả</td></tr>'
                );
                $('#resultStats').text('');
                $('#pagination').empty();
            });

            // Xử lý submit form
            $('#filterForm').submit(function (e) {
                e.preventDefault();
                applyFilters();
            });

            // Áp dụng bộ lọc
            function applyFilters() {
                var formData = $('#filterForm').serialize();

                $.ajax({
                    url: '@Url.Action("FilterGiaoDich", "DanhMucs")',
                    type: 'GET',
                    data: formData,
                    beforeSend: function () {
                        $('#resultsTable tbody').html(
                            '<tr><td colspan="5" class="text-center">' +
                            '<div class="spinner-border text-primary" role="status">' +
                            '<span class="visually-hidden">Loading...</span></div></td></tr>'
                        );
                    },
                    success: function (response) {
                        if (response.success) {
                            displayResults(response);
                        } else {
                            $('#resultsTable tbody').html(
                                '<tr><td colspan="5" class="text-center text-danger">' +
                                response.message + '</td></tr>'
                            );
                        }
                    },
                    error: function (xhr, status, error) {
                        $('#resultsTable tbody').html(
                            '<tr><td colspan="5" class="text-center text-danger">' +
                            'Lỗi khi tải dữ liệu: ' + error + '</td></tr>'
                        );
                    }
                });
            }

            // Hiển thị kết quả
            function displayResults(data) {
                var tbody = $('#resultsTable tbody');
                tbody.empty();

                if (data.giaoDichList && data.giaoDichList.length > 0) {
                    $.each(data.giaoDichList, function (index, item) {
                        var row = '<tr>' +
                            '<td>' + formatDate(item.NgayGD) + '</td>' +
                            '<td>' + (item.MoTa || 'N/A') + '</td>' +
                            '<td>' + (item.DanhMucTen || 'N/A') + '</td>' +
                            '<td><span class="' + (item.Loai === 'Thu' ? 'text-success' : 'text-danger') + ' fw-bold">' +
                                formatCurrency(item.SoTien) + ' VNĐ</span></td>' +
                            '<td class="text-center">' +
                                '<a href="@Url.Action("Edit", "DanhMucs")/' + item.MaDanhMuc + '" class="btn btn-outline-info btn-sm me-1">Sửa</a>' +
                                '<a href="@Url.Action("Details", "DanhMucs")/' + item.MaDanhMuc + '" class="btn btn-outline-secondary btn-sm me-1">Chi tiết</a>' +
                            '</td>' +
                            '</tr>';
                        tbody.append(row);
                    });

                    // Hiển thị thống kê
                    $('#resultStats').html(
                        '<strong>Tìm thấy ' + data.totalCount + ' giao dịch</strong><br>' +
                        '<span class="text-muted">Tổng tiền: ' + formatCurrency(data.totalAmount) + ' VNĐ</span>'
                    );
                } else {
                    tbody.html(
                        '<tr id="noResults"><td colspan="5" class="text-center text-muted py-4">' +
                        '<i class="bi bi-search fs-1 d-block mb-2"></i>' +
                        'Không tìm thấy giao dịch nào phù hợp</td></tr>'
                    );
                    $('#resultStats').text('Không có kết quả');
                }
            }

            // Định dạng ngày
            function formatDate(dateString) {
                try {
                    var date = new Date(dateString);
                    if (isNaN(date.getTime())) {
                        return 'N/A';
                    }
                    return date.toLocaleDateString('vi-VN', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                } catch (e) {
                    return 'N/A';
                }
            }

            // Định dạng tiền tệ
            function formatCurrency(amount) {
                if (!amount && amount !== 0) return '0';
                return new Intl.NumberFormat('vi-VN').format(amount);
            }

            // Tự động áp dụng bộ lọc nếu có tham số trong URL
            var urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('filterType')) {
                // Set giá trị từ URL
                $('#filterType').val(urlParams.get('filterType') || 'all');
                $('#filterType').trigger('change');

                // Set các giá trị khác
                $('#specificDate').val(urlParams.get('specificDate') || '');
                $('#month').val(urlParams.get('month') || '');
                $('#fromDate').val(urlParams.get('fromDate') || '');
                $('#toDate').val(urlParams.get('toDate') || '');
                $('#categoryId').val(urlParams.get('categoryId') || '');
                $('#minAmount').val(urlParams.get('minAmount') || '');
                $('#maxAmount').val(urlParams.get('maxAmount') || '');

                // Áp dụng filter
                setTimeout(applyFilters, 500);
            }
        });
    </script>

    <style>
        .filter-option {
            transition: all 0.3s ease;
        }

        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }

        .text-success {
            color: #198754 !important;
        }

        .text-danger {
            color: #dc3545 !important;
        }

        .spinner-border {
            width: 2rem;
            height: 2rem;
        }
    </style>
}